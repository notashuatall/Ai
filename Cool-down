<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai is Ernesa - Universal AI Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: white;
        }

        .app-container.dark-mode {
            background: #121212;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            background: #fff;
            transition: transform 0.3s ease;
            z-index: 40;
        }

        .app-container.dark-mode .sidebar {
            background: #1e1e1e;
            border-right-color: #333;
        }

        .sidebar.mobile-hidden {
            transform: translateX(-100%);
            position: absolute;
            height: 100%;
            top: 0;
            left: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .app-container.dark-mode .sidebar-header {
            border-bottom-color: #333;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .logo-img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><filter id="grain"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" result="noise"/><feDisplacementMap in="SourceGraphic" in2="noise" scale="20"/></filter></defs><circle cx="50" cy="50" r="45" fill="white" opacity="0.8" filter="url(%23grain)"/><path d="M40 30 Q50 45 60 30 M40 50 Q50 65 60 50 M30 40 Q45 50 30 60 M70 40 Q55 50 70 60" stroke="black" stroke-width="2" fill="none" opacity="0.9"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .app-container.dark-mode .logo-text {
            color: #e5e7eb;
        }

        .new-chat-btn {
            padding: 8px 12px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #1f2937;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .app-container.dark-mode .new-chat-btn {
            background: #2a2a2a;
            border-color: #444;
            color: #e5e7eb;
        }

        .new-chat-btn:hover {
            background: #e5e7eb;
        }

        .app-container.dark-mode .new-chat-btn:hover {
            background: #3a3a3a;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .chat-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .app-container.dark-mode .chat-item {
            background: #2a2a2a;
            color: #b0b0b0;
        }

        .chat-item:hover {
            background: #e5e7eb;
        }

        .app-container.dark-mode .chat-item:hover {
            background: #333;
        }

        .chat-item.active {
            background: #667eea;
            color: white;
        }

        .chat-item-title {
            flex: 1;
            min-width: 0;
        }

        .chat-item-actions {
            display: none;
            gap: 4px;
        }

        .chat-item:hover .chat-item-actions {
            display: flex;
        }

        .chat-item-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .chat-item-btn:hover {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }

        .app-container.dark-mode .sidebar-footer {
            border-top-color: #333;
        }

        .settings-btn, .dark-mode-btn {
            flex: 1;
            padding: 8px 12px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #1f2937;
            transition: all 0.2s;
        }

        .app-container.dark-mode .settings-btn,
        .app-container.dark-mode .dark-mode-btn {
            background: #2a2a2a;
            border-color: #444;
            color: #e5e7eb;
        }

        .settings-btn:hover, .dark-mode-btn:hover {
            background: #e5e7eb;
        }

        .app-container.dark-mode .settings-btn:hover,
        .app-container.dark-mode .dark-mode-btn:hover {
            background: #3a3a3a;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .app-container.dark-mode .main-content {
            background: #121212;
        }

        .main-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .app-container.dark-mode .main-header {
            border-bottom-color: #333;
        }

        @media (max-width: 768px) {
            .main-header {
                display: flex;
            }
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #1f2937;
        }

        .app-container.dark-mode .menu-btn {
            color: #e5e7eb;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .app-container.dark-mode .chat-title {
            color: #e5e7eb;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .messages-container.empty {
            justify-content: center;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            color: #9ca3af;
        }

        .app-container.dark-mode .empty-state {
            color: #666;
        }

        .empty-state-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .app-container.dark-mode .empty-state-title {
            color: #e5e7eb;
        }

        .empty-state-subtitle {
            font-size: 14px;
            color: #9ca3af;
        }

        /* Message Styles */
        .message {
            display: flex;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-content {
            background: #f3f4f6;
            color: #1f2937;
            border-bottom-left-radius: 4px;
        }

        .app-container.dark-mode .message.ai .message-content {
            background: #2a2a2a;
            color: #e5e7eb;
        }

        /* Markdown in messages */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin-top: 12px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .message-content p {
            margin: 8px 0;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .message.user .message-content code {
            background: rgba(0, 0, 0, 0.2);
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.15);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .app-container.dark-mode .message.ai .message-content pre {
            background: rgba(0, 0, 0, 0.4);
        }

        .message-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .message-content ul,
        .message-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .message-content a {
            color: #667eea;
            text-decoration: underline;
        }

        .message.user .message-content a {
            color: inherit;
        }

        .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 12px;
            margin: 8px 0;
            color: #6b7280;
        }

        .app-container.dark-mode .message.ai .message-content blockquote {
            color: #9ca3af;
            border-left-color: #555;
        }

        /* Input Area */
        .input-area {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .app-container.dark-mode .input-area {
            background: #1e1e1e;
            border-top-color: #333;
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            min-height: 40px;
            color: #1f2937;
            background: white;
        }

        .app-container.dark-mode .input-field {
            background: #2a2a2a;
            border-color: #444;
            color: #e5e7eb;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-field::placeholder {
            color: #9ca3af;
        }

        .app-container.dark-mode .input-field::placeholder {
            color: #666;
        }

        .send-btn {
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #5568d3;
        }

        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .app-container.dark-mode .send-btn:disabled {
            background: #444;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .app-container.dark-mode .modal {
            background: #1e1e1e;
            color: #e5e7eb;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1f2937;
        }

        .app-container.dark-mode .modal-header {
            color: #e5e7eb;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #374151;
        }

        .app-container.dark-mode .form-label {
            color: #d1d1d1;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            color: #1f2937;
            background: white;
            box-sizing: border-box;
        }

        .app-container.dark-mode .form-input,
        .app-container.dark-mode .form-textarea {
            background: #2a2a2a;
            border-color: #444;
            color: #e5e7eb;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        .btn-primary,
        .btn-secondary,
        .btn-danger {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }

        .app-container.dark-mode .btn-secondary {
            background: #2a2a2a;
            color: #e5e7eb;
            border-color: #444;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .app-container.dark-mode .btn-secondary:hover {
            background: #3a3a3a;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                max-height: 60px;
            }

            .sidebar.mobile-hidden {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                width: 280px;
                border-right: 1px solid #e5e7eb;
                border-bottom: none;
                max-height: 100%;
            }

            .sidebar-header {
                padding: 12px;
            }

            .chat-history {
                display: none;
            }

            .sidebar.mobile-hidden .chat-history {
                display: flex;
                flex-direction: column;
            }

            .sidebar-footer {
                display: none;
            }

            .sidebar.mobile-hidden .sidebar-footer {
                display: flex;
            }

            .messages-container {
                padding: 16px 12px;
                gap: 12px;
            }

            .message-content {
                max-width: 85%;
            }

            .input-area {
                padding: 12px;
            }

            .input-field {
                font-size: 16px;
            }

            .modal {
                width: 95%;
                max-height: 85vh;
            }
        }

        @media (max-width: 480px) {
            .sidebar-header {
                padding: 10px;
            }

            .logo-img {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            .messages-container {
                padding: 12px 8px;
            }

            .message-content {
                max-width: 90%;
                padding: 10px 12px;
            }

            .input-area {
                padding: 10px;
            }

            .input-field {
                padding: 8px 12px;
                font-size: 16px;
            }

            .send-btn {
                padding: 8px 12px;
                min-width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.5;
            }
            30% {
                opacity: 1;
            }
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
            z-index: 100;
        }

        #loading.hidden {
            display: none;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 30;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .app-container.dark-mode .error-message {
            background: #7f1d1d;
            color: #fca5a5;
        }

        .success-message {
            background: #dcfce7;
            color: #16a34a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .app-container.dark-mode .success-message {
            background: #1b4332;
            color: #86efac;
        }
    </style>
</head>
<body>
    <div id="loading">Loading Ernesa...</div>

    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-section">
                    <div class="logo-img" title="Ernesa"></div>
                    <div class="logo-text">Ernesa</div>
                </div>
                <button class="new-chat-btn" id="newChatBtn">+</button>
            </div>

            <div class="chat-history" id="chatHistory"></div>

            <div class="sidebar-footer">
                <button class="settings-btn" id="settingsBtn">‚öô Settings</button>
                <button class="dark-mode-btn" id="darkModeBtn">üåô</button>
            </div>
        </div>

        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header" id="mainHeader">
                <button class="menu-btn" id="menuBtn">‚ò∞</button>
                <div class="chat-title" id="chatTitle">Ernesa</div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <div class="empty-state-logo">‚ú®</div>
                    <div class="empty-state-title">Welcome to Ernesa</div>
                    <div class="empty-state-subtitle">Start a new conversation</div>
                </div>
            </div>

            <div class="input-area">
                <div id="errorMessage"></div>
                <div class="input-wrapper">
                    <textarea 
                        class="input-field" 
                        id="inputField" 
                        placeholder="Ask Ernesa anything..."
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn">‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">Settings</div>
            
            <div class="form-group">
                <label class="form-label">OpenRouter API Key</label>
                <input 
                    type="password" 
                    class="form-input" 
                    id="apiKeyInput" 
                    placeholder="sk-or-..."
                >
            </div>

            <div class="form-group">
                <label class="form-label">Model</label>
                <input 
                    type="text" 
                    class="form-input" 
                    id="modelInput" 
                    placeholder="deepseek/deepseek-r1:free"
                    value="deepseek/deepseek-r1:free"
                >
            </div>

            <div class="form-group">
                <label class="form-label">System Prompt</label>
                <textarea 
                    class="form-textarea" 
                    id="systemPromptInput"
                    placeholder="You are a helpful AI assistant..."
                ></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" id="closeSettingsBtn">Cancel</button>
                <button class="btn-primary" id="saveSettingsBtn">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Delete Chat Confirmation Modal -->
    <div class="modal-overlay" id="deleteConfirmModal">
        <div class="modal">
            <div class="modal-header">Delete Chat?</div>
            <p>This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancelDeleteBtn">Cancel</button>
                <button class="btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Rename Chat Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <div class="modal-header">Rename Chat</div>
            <div class="form-group">
                <input 
                    type="text" 
                    class="form-input" 
                    id="renameInput" 
                    placeholder="Enter chat name..."
                >
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancelRenameBtn">Cancel</button>
                <button class="btn-primary" id="confirmRenameBtn">Rename</button>
            </div>
        </div>
    </div>

    <script>
        // ====================
        // APP INITIALIZATION
        // ====================

        const app = {
            // State
            currentChatId: null,
            chats: {},
            darkMode: false,
            apiKey: '',
            model: 'deepseek/deepseek-r1:free',
            systemPrompt: 'You are a helpful, harmless, and honest AI assistant named Ernesa.',
            isLoading: false,
            deleteTargetId: null,
            renameTargetId: null,

            // Elements
            elements: {},

            // Initialize app
            async init() {
                try {
                    this.cacheElements();
                    this.loadSettings();
                    this.setupEventListeners();
                    this.hideLazyLoader();
                    this.loadChatsFromStorage();
                    this.renderChatHistory();
                    this.applyDarkMode();
                    this.setupInputAutoResize();
                    this.setupResponsive();
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showMessage('Error initializing app', 'error');
                }
            },

            // Cache DOM elements
            cacheElements() {
                this.elements = {
                    appContainer: document.getElementById('appContainer'),
                    sidebar: document.getElementById('sidebar'),
                    sidebarOverlay: document.getElementById('sidebarOverlay'),
                    messagesContainer: document.getElementById('messagesContainer'),
                    inputField: document.getElementById('inputField'),
                    sendBtn: document.getElementById('sendBtn'),
                    chatHistory: document.getElementById('chatHistory'),
                    newChatBtn: document.getElementById('newChatBtn'),
                    settingsBtn: document.getElementById('settingsBtn'),
                    darkModeBtn: document.getElementById('darkModeBtn'),
                    settingsModal: document.getElementById('settingsModal'),
                    apiKeyInput: document.getElementById('apiKeyInput'),
                    modelInput: document.getElementById('modelInput'),
                    systemPromptInput: document.getElementById('systemPromptInput'),
                    saveSettingsBtn: document.getElementById('saveSettingsBtn'),
                    closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                    deleteConfirmModal: document.getElementById('deleteConfirmModal'),
                    confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
                    cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
                    renameModal: document.getElementById('renameModal'),
                    renameInput: document.getElementById('renameInput'),
                    confirmRenameBtn: document.getElementById('confirmRenameBtn'),
                    cancelRenameBtn: document.getElementById('cancelRenameBtn'),
                    menuBtn: document.getElementById('menuBtn'),
                    mainHeader: document.getElementById('mainHeader'),
                    chatTitle: document.getElementById('chatTitle'),
                    errorMessage: document.getElementById('errorMessage'),
                };
            },

            // Hide loading overlay
            hideLazyLoader() {
                const loader = document.getElementById('loading');
                if (loader) {
                    setTimeout(() => {
                        loader.classList.add('hidden');
                    }, 300);
                }
            },

            // Setup responsive behavior
            setupResponsive() {
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 768) {
                        this.elements.sidebar.classList.remove('mobile-hidden');
                        this.elements.sidebarOverlay.classList.remove('active');
                    }
                });
            },

            // Setup event listeners
            setupEventListeners() {
                // Chat
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.inputField.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Navigation
                this.elements.newChatBtn.addEventListener('click', () => this.createNewChat());
                this.elements.settingsBtn.addEventListener('click', () => this.openSettings());
                this.elements.darkModeBtn.addEventListener('click', () => this.toggleDarkMode());
                this.elements.menuBtn.addEventListener('click', () => this.toggleSidebar());
                this.elements.sidebarOverlay.addEventListener('click', () => this.closeSidebar());

                // Settings Modal
                this.elements.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
                this.elements.closeSettingsBtn.addEventListener('click', () => this.closeSettings());

                // Delete Modal
                this.elements.confirmDeleteBtn.addEventListener('click', () => this.confirmDelete());
                this.elements.cancelDeleteBtn.addEventListener('click', () => this.closeDeleteConfirm());

                // Rename Modal
                this.elements.confirmRenameBtn.addEventListener('click', () => this.confirmRename());
                this.elements.cancelRenameBtn.addEventListener('click', () => this.closeRenameModal());
            },

            // Setup textarea auto-resize
            setupInputAutoResize() {
                const textarea = this.elements.inputField;
                textarea.addEventListener('input', () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
                });
            },

            // Load settings from localStorage
            loadSettings() {
                try {
                    const saved = localStorage.getItem('ernesaSettings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.apiKey = settings.apiKey || '';
                        this.model = settings.model || 'deepseek/deepseek-r1:free';
                        this.systemPrompt = settings.systemPrompt || 'You are a helpful, harmless, and honest AI assistant named Ernesa.';
                        this.darkMode = settings.darkMode || false;
                    }
                } catch (e) {
                    console.error('Failed to load settings:', e);
                }
            },

            // Save settings to localStorage
            saveSettings() {
                try {
                    this.apiKey = this.elements.apiKeyInput.value || '';
                    this.model = this.elements.modelInput.value || 'deepseek/deepseek-r1:free';
                    this.systemPrompt = this.elements.systemPromptInput.value || 'You are a helpful, harmless, and honest AI assistant named Ernesa.';

                    localStorage.setItem('ernesaSettings', JSON.stringify({
                        apiKey: this.apiKey,
                        model: this.model,
                        systemPrompt: this.systemPrompt,
                        darkMode: this.darkMode,
                    }));

                    this.showMessage('‚úì Settings saved!', 'success');
                    this.closeSettings();
                } catch (error) {
                    this.showMessage('Failed to save settings', 'error');
                    console.error('Save settings error:', error);
                }
            },

            // Open settings modal
            openSettings() {
                this.elements.apiKeyInput.value = this.apiKey;
                this.elements.modelInput.value = this.model;
                this.elements.systemPromptInput.value = this.systemPrompt;
                this.elements.settingsModal.classList.add('active');
            },

            // Close settings modal
            closeSettings() {
                this.elements.settingsModal.classList.remove('active');
            },

            // Toggle dark mode
            toggleDarkMode() {
                this.darkMode = !this.darkMode;
                this.applyDarkMode();
                try {
                    localStorage.setItem('ernesaSettings', JSON.stringify({
                        apiKey: this.apiKey,
                        model: this.model,
                        systemPrompt: this.systemPrompt,
                        darkMode: this.darkMode,
                    }));
                } catch (error) {
                    console.error('Failed to save dark mode preference:', error);
                }
            },

            // Apply dark mode
            applyDarkMode() {
                if (this.darkMode) {
                    this.elements.appContainer.classList.add('dark-mode');
                    this.elements.darkModeBtn.textContent = '‚òÄÔ∏è';
                } else {
                    this.elements.appContainer.classList.remove('dark-mode');
                    this.elements.darkModeBtn.textContent = 'üåô';
                }
            },

            // Load chats from localStorage
            loadChatsFromStorage() {
                try {
                    const saved = localStorage.getItem('ernesaChats');
                    if (saved) {
                        this.chats = JSON.parse(saved);
                        if (Object.keys(this.chats).length > 0) {
                            this.currentChatId = Object.keys(this.chats)[0];
                            this.renderChat();
                        }
                    }
                } catch (e) {
                    console.error('Failed to load chats:', e);
                    this.chats = {};
                }
            },

            // Save chats to localStorage
            saveChats() {
                try {
                    localStorage.setItem('ernesaChats', JSON.stringify(this.chats));
                } catch (error) {
                    console.error('Failed to save chats:', error);
                }
            },

            // Create new chat
            createNewChat() {
                try {
                    const id = Date.now().toString();
                    this.chats[id] = {
                        id,
                        title: `Chat ${Object.keys(this.chats).length + 1}`,
                        messages: [],
                        createdAt: new Date().toISOString(),
                    };
                    this.currentChatId = id;
                    this.saveChats();
                    this.renderChatHistory();
                    this.renderChat();
                    this.closeSidebar();
                    this.showMessage('‚úì New chat created!', 'success');
                } catch (error) {
                    this.showMessage('Failed to create chat', 'error');
                    console.error('Create chat error:', error);
                }
            },

            // Render chat history sidebar
            renderChatHistory() {
                try {
                    const container = this.elements.chatHistory;
                    container.innerHTML = '';

                    const sortedChats = Object.values(this.chats).sort((a, b) => 
                        new Date(b.createdAt) - new Date(a.createdAt)
                    );

                    sortedChats.forEach(chat => {
                        const item = document.createElement('div');
                        item.className = `chat-item ${chat.id === this.currentChatId ? 'active' : ''}`;
                        item.innerHTML = `
                            <div class="chat-item-title">${this.escapeHtml(chat.title)}</div>
                            <div class="chat-item-actions">
                                <button class="chat-item-btn" data-rename="${chat.id}" title="Rename">‚úèÔ∏è</button>
                                <button class="chat-item-btn" data-delete="${chat.id}" title="Delete">üóëÔ∏è</button>
                            </div>
                        `;

                        item.addEventListener('click', (e) => {
                            if (!e.target.closest('.chat-item-btn')) {
                                this.currentChatId = chat.id;
                                this.renderChatHistory();
                                this.renderChat();
                                this.closeSidebar();
                            }
                        });

                        item.querySelector('[data-rename]').addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.openRenameModal(chat.id);
                        });

                        item.querySelector('[data-delete]').addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.openDeleteConfirm(chat.id);
                        });

                        container.appendChild(item);
                    });
                } catch (error) {
                    console.error('Render chat history error:', error);
                }
            },

            // Render current chat messages
            renderChat() {
                try {
                    const chat = this.chats[this.currentChatId];
                    if (!chat) return;

                    this.elements.chatTitle.textContent = this.escapeHtml(chat.title);

                    if (chat.messages.length === 0) {
                        this.elements.messagesContainer.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-logo">‚ú®</div>
                                <div class="empty-state-title">Welcome to Ernesa</div>
                                <div class="empty-state-subtitle">Start a new conversation</div>
                            </div>
                        `;
                    } else {
                        this.elements.messagesContainer.innerHTML = '';
                        chat.messages.forEach(msg => {
                            this.renderMessage(msg);
                        });
                        this.scrollToBottom();
                    }
                } catch (error) {
                    console.error('Render chat error:', error);
                }
            },

            // Render single message
            renderMessage(message) {
                try {
                    const container = this.elements.messagesContainer;
                    
                    // Remove empty state
                    const emptyState = container.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.remove();
                    }

                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${message.role}`;
                    
                    const contentEl = document.createElement('div');
                    contentEl.className = 'message-content';
                    
                    if (message.role === 'user') {
                        contentEl.textContent = message.content;
                    } else {
                        // Render markdown for AI messages
                        try {
                            if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                                contentEl.innerHTML = DOMPurify.sanitize(marked.parse(message.content));
                            } else {
                                contentEl.textContent = message.content;
                            }
                        } catch (e) {
                            contentEl.textContent = message.content;
                        }
                    }

                    messageEl.appendChild(contentEl);
                    container.appendChild(messageEl);
                } catch (error) {
                    console.error('Render message error:', error);
                }
            },

            // Render typing indicator
            renderTypingIndicator() {
                try {
                    const container = this.elements.messagesContainer;
                    const msgEl = document.createElement('div');
                    msgEl.className = 'message ai';
                    msgEl.id = 'typingIndicator';
                    
                    const contentEl = document.createElement('div');
                    contentEl.className = 'message-content typing-indicator';
                    contentEl.innerHTML = `
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    
                    msgEl.appendChild(contentEl);
                    container.appendChild(msgEl);
                    this.scrollToBottom();
                } catch (error) {
                    console.error('Render typing indicator error:', error);
                }
            },

            // Remove typing indicator
            removeTypingIndicator() {
                try {
                    const indicator = document.getElementById('typingIndicator');
                    if (indicator) {
                        indicator.remove();
                    }
                } catch (error) {
                    console.error('Remove typing indicator error:', error);
                }
            },

            // Send message
            async sendMessage() {
                try {
                    const content = this.elements.inputField.value.trim();
                    if (!content || this.isLoading) return;

                    if (!this.apiKey) {
                        this.showMessage('‚ö†Ô∏è Please set your OpenRouter API key in settings', 'error');
                        this.openSettings();
                        return;
                    }

                    // Clear input
                    this.elements.inputField.value = '';
                    this.elements.inputField.style.height = 'auto';
                    
                    const chat = this.chats[this.currentChatId];
                    if (!chat) return;

                    // Add user message
                    const userMessage = { role: 'user', content };
                    chat.messages.push(userMessage);
                    this.renderMessage(userMessage);
                    this.saveChats();

                    // Update chat title if first message
                    if (chat.messages.length === 1) {
                        chat.title = content.substring(0, 50) || 'Untitled Chat';
                        this.saveChats();
                        this.renderChatHistory();
                    }

                    // Get AI response
                    this.isLoading = true;
                    this.elements.sendBtn.disabled = true;
                    this.renderTypingIndicator();

                    try {
                        const response = await this.getAIResponse(chat.messages);
                        this.removeTypingIndicator();
                        
                        const aiMessage = { role: 'assistant', content: response };
                        chat.messages.push(aiMessage);
                        this.renderMessage(aiMessage);
                        this.saveChats();
                    } catch (error) {
                        this.removeTypingIndicator();
                        const errorMsg = error.message || 'Failed to get response';
                        this.showMessage(`‚ùå ${errorMsg}`, 'error');
                        console.error('API Error:', error);
                    } finally {
                        this.isLoading = false;
                        this.elements.sendBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Send message error:', error);
                    this.isLoading = false;
                    this.elements.sendBtn.disabled = false;
                }
            },

            // Get AI response with streaming
            async getAIResponse(messages) {
                const payload = {
                    model: this.model,
                    messages: [
                        { role: 'system', content: this.systemPrompt },
                        ...messages
                    ],
                    stream: true,
                };

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`,
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    try {
                        const error = await response.json();
                        throw new Error(error.error?.message || `API Error: ${response.status}`);
                    } catch {
                        throw new Error(`API Error: ${response.status}`);
                    }
                }

                return this.handleStream(response);
            },

            // Handle streaming response
            async handleStream(response) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';

                // Remove typing indicator and create message element
                this.removeTypingIndicator();
                const container = this.elements.messagesContainer;
                const msgEl = document.createElement('div');
                msgEl.className = 'message ai';
                const contentEl = document.createElement('div');
                contentEl.className = 'message-content';
                msgEl.appendChild(contentEl);
                container.appendChild(msgEl);

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;

                                try {
                                    const parsed = JSON.parse(data);
                                    const delta = parsed.choices?.[0]?.delta?.content;
                                    if (delta) {
                                        fullContent += delta;
                                        // Update with markdown rendering
                                        try {
                                            if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                                                contentEl.innerHTML = DOMPurify.sanitize(marked.parse(fullContent));
                                            } else {
                                                contentEl.textContent = fullContent;
                                            }
                                        } catch {
                                            contentEl.textContent = fullContent;
                                        }
                                        this.scrollToBottom();
                                    }
                                } catch (e) {
                                    // Ignore JSON parse errors from incomplete data
                                }
                            }
                        }
                    }
                } catch (error) {
                    throw new Error('Stream error: ' + error.message);
                }

                return fullContent || 'No response received';
            },

            // Scroll to bottom
            scrollToBottom() {
                try {
                    this.elements.messagesContainer.scrollTop = 
                        this.elements.messagesContainer.scrollHeight;
                } catch (error) {
                    console.error('Scroll error:', error);
                }
            },

            // Delete chat
            openDeleteConfirm(chatId) {
                this.deleteTargetId = chatId;
                this.elements.deleteConfirmModal.classList.add('active');
            },

            confirmDelete() {
                try {
                    if (this.deleteTargetId && this.chats[this.deleteTargetId]) {
                        delete this.chats[this.deleteTargetId];
                        this.saveChats();
                        
                        if (this.currentChatId === this.deleteTargetId) {
                            this.currentChatId = Object.keys(this.chats)[0] || null;
                        }
                        
                        this.renderChatHistory();
                        if (this.currentChatId) {
                            this.renderChat();
                        } else {
                            this.elements.messagesContainer.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-state-logo">‚ú®</div>
                                    <div class="empty-state-title">No chats</div>
                                    <div class="empty-state-subtitle">Start a new conversation</div>
                                </div>
                            `;
                        }
                    }
                    this.closeDeleteConfirm();
                    this.showMessage('‚úì Chat deleted!', 'success');
                } catch (error) {
                    this.showMessage('Failed to delete chat', 'error');
                    console.error('Delete error:', error);
                }
            },

            closeDeleteConfirm() {
                this.elements.deleteConfirmModal.classList.remove('active');
                this.deleteTargetId = null;
            },

            // Rename chat
            openRenameModal(chatId) {
                try {
                    this.renameTargetId = chatId;
                    const chat = this.chats[chatId];
                    this.elements.renameInput.value = chat ? chat.title : '';
                    this.elements.renameModal.classList.add('active');
                    this.elements.renameInput.focus();
                } catch (error) {
                    console.error('Open rename modal error:', error);
                }
            },

            confirmRename() {
                try {
                    const newTitle = this.elements.renameInput.value.trim();
                    if (newTitle && this.renameTargetId && this.chats[this.renameTargetId]) {
                        this.chats[this.renameTargetId].title = newTitle;
                        this.saveChats();
                        this.renderChatHistory();
                        if (this.currentChatId === this.renameTargetId) {
                            this.elements.chatTitle.textContent = newTitle;
                        }
                        this.showMessage('‚úì Chat renamed!', 'success');
                    }
                    this.closeRenameModal();
                } catch (error) {
                    this.showMessage('Failed to rename chat', 'error');
                    console.error('Rename error:', error);
                }
            },

            closeRenameModal() {
                this.elements.renameModal.classList.remove('active');
                this.renameTargetId = null;
            },

            // Toggle sidebar on mobile
            toggleSidebar() {
                this.elements.sidebar.classList.toggle('mobile-hidden');
                this.elements.sidebarOverlay.classList.toggle('active');
            },

            closeSidebar() {
                if (window.innerWidth <= 768) {
                    this.elements.sidebar.classList.add('mobile-hidden');
                    this.elements.sidebarOverlay.classList.remove('active');
                }
            },

            // Show message (error/success)
            showMessage(text, type) {
                try {
                    const container = this.elements.errorMessage;
                    container.innerHTML = `<div class="${type}-message">${this.escapeHtml(text)}</div>`;
                    setTimeout(() => {
                        container.innerHTML = '';
                    }, 3000);
                } catch (error) {
                    console.error('Show message error:', error);
                }
            },

            // Escape HTML
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
        };

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
    </script>
</body>
</html>
